version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - export FLASK_APP=wsgi.py
            - export FLASK_ENV=production
            - pip install --upgrade pip
            - pip install eventlet==0.37.0 Werkzeug==2.3.7 Flask==2.3.3 gunicorn==23.0.0
            - |
              cat << 'EOF' > start.sh
              #!/bin/bash
              set -e
              
              echo "Starting Gunicorn..."
              gunicorn \
                --worker-class eventlet \
                --workers 1 \
                --bind 0.0.0.0:8000 \
                --forwarded-allow-ips="*" \
                --daemon \
                --pid gunicorn.pid \
                --access-logfile - \
                --error-logfile - \
                wsgi:wsgi &
              
              sleep 5
              
              if kill -0 $(cat gunicorn.pid) 2>/dev/null; then
                  echo "Gunicorn started successfully"
                  curl -v http://localhost:8000/health
                  exit 0
              else
                  echo "Gunicorn failed to start"
                  exit 1
              fi
              EOF
            - chmod +x start.sh
        build:
          commands:
            - ./start.sh
      artifacts:
        baseDirectory: .
        files:
          - '**/*'
      cache:
        paths:
          - /root/.cache/pip
      customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Cache-Control'
              value: 'no-store'
            - key: 'X-Frame-Options'
              value: 'SAMEORIGIN'
    appRoot: .