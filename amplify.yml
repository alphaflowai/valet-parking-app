version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - pip install --upgrade pip
            - pip install -r requirements.txt
            - export FLASK_APP=run.py
            - export FLASK_ENV=development
            - export PYTHONPATH=$PYTHONPATH:/codebuild/output/src2603305598/src/valet-parking-app
            - |
              echo '#!/bin/bash
              # Enable debug output
              set -x

              echo "Starting Gunicorn..."
              
              # Start Gunicorn without config file
              gunicorn \
                --worker-class eventlet \
                --workers 1 \
                --bind 0.0.0.0:8000 \
                --timeout 30 \
                --keep-alive 2 \
                --log-level debug \
                --error-logfile - \
                --access-logfile - \
                --capture-output \
                wsgi:wsgi &

              # Store the PID
              GUNICORN_PID=$!
              
              echo "Gunicorn started with PID: $GUNICORN_PID"
              
              # Wait a bit for initial startup
              sleep 5
              
              # Check if process is still running
              if ps -p $GUNICORN_PID > /dev/null; then
                echo "Gunicorn process is running"
                
                # Try to connect to the health endpoint
                echo "Testing connection to health endpoint..."
                curl -v http://localhost:8000/health
                
                # Keep running
                wait $GUNICORN_PID
              else
                echo "Gunicorn process failed to start"
                exit 1
              fi' > start.sh
            - chmod +x start.sh
        build:
          commands:
            - echo "Current directory: $(pwd)"
            - echo "Python path: $PYTHONPATH"
            - echo "Starting Flask application with Gunicorn"
            - ./start.sh
      artifacts:
        baseDirectory: .
        files:
          - '**/*'
      cache:
        paths:
          - .pip-cache
    appRoot: .