version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - export FLASK_APP=wsgi.py
            - export FLASK_ENV=production
            - pip install --upgrade pip
            - pip install eventlet==0.37.0 Werkzeug==2.3.7 Flask==2.3.3 gunicorn==23.0.0
            - |
              cat << 'EOF' > start.sh
              #!/bin/bash
              set -e
              
              echo "Starting Gunicorn..."
              
              # Start Gunicorn and capture its PID
              gunicorn \
                --worker-class eventlet \
                --workers 1 \
                --bind 127.0.0.1:8000 \
                --forwarded-allow-ips="*" \
                --access-logfile access.log \
                --error-logfile error.log \
                wsgi:wsgi &
              
              GUNICORN_PID=$!
              echo $GUNICORN_PID > gunicorn.pid
              
              echo "Gunicorn started with PID: $GUNICORN_PID"
              sleep 5
              
              # Check if process is running and test endpoint
              if ps -p $GUNICORN_PID > /dev/null; then
                  echo "Testing health endpoint..."
                  RESPONSE=$(curl -s http://127.0.0.1:8000/health)
                  if [ $? -eq 0 ]; then
                      echo "Health check successful: $RESPONSE"
                      # Keep the process running
                      wait $GUNICORN_PID
                      exit 0
                  else
                      echo "Health check failed"
                      kill $GUNICORN_PID
                      exit 1
                  fi
              else
                  echo "Process failed to start"
                  if [ -f error.log ]; then
                      echo "Error log contents:"
                      cat error.log
                  fi
                  exit 1
              fi
              EOF
            - chmod +x start.sh
        build:
          commands:
            - ./start.sh
      artifacts:
        baseDirectory: .
        files:
          - '**/*'
          - error.log
          - access.log
      cache:
        paths:
          - /root/.cache/pip
    appRoot: .